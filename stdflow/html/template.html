<html>
<body>
<h1 id="name"></h1>
<p id="type"></p>
<h2>Step</h2>
<p id="attrs"></p>
<p id="version"></p>
<p id="step"></p>
<h2>Columns</h2>
<ul id="columns"></ul>
<h2>Input Files</h2>
<ul id="input_files"></ul>
<h2>Output Files</h2>
<ul id="output_files"></ul>
<h2>Pipeline</h2>
<svg id="pipeline" width="900" height="500"></svg>

<svg width="5000" height="5000" id="svg">
    <defs>
        <marker id="arrow" markerWidth="4" markerHeight="4" refX="0" refY="2" orient="auto" markerUnits="strokeWidth">
            <path d="M0,0 L0,4 L4,2 z" fill="rgba(0, 0, 0, 0.3)" />
        </marker>
    </defs>
</svg>


<script src="data.js"></script>
<script>
    var currentFile = data.files[0];
    updatePage();

    function updatePage() {
        document.getElementById('name').textContent = currentFile.name;
        document.getElementById('type').textContent = 'Type: ' + currentFile.type;
        document.getElementById('attrs').textContent = 'Attributes: ' + currentFile.step.attrs.join(', ');
        document.getElementById('version').textContent = 'Version: ' + currentFile.step.version;
        document.getElementById('step').textContent = 'Step: ' + currentFile.step.step;

        var columnsList = document.getElementById('columns');
        columnsList.innerHTML = '';
        currentFile.columns.forEach(function (column) {
            var li = document.createElement('li');
            li.textContent = column.name + ' (' + column.type + '): ' + column.description;
            columnsList.appendChild(li);
        });

        var inputFilesList = document.getElementById('input_files');
        inputFilesList.innerHTML = '';
        currentFile.input_files.forEach(function (inputFile) {
            var li = document.createElement('li');
            var a = document.createElement('a');
            var fileInData = data.files.find(function (file) {
                return file.uuid === inputFile.uuid;
            });
            a.textContent = fileInData.name;
            a.href = '#';
            a.onclick = function () {
                currentFile = fileInData;
                updatePage();
                return false;
            };
            li.appendChild(a);
            inputFilesList.appendChild(li);
        });

        var outputFilesList = document.getElementById('output_files');
        outputFilesList.innerHTML = '';
        data.files.forEach(function (file) {
            file.input_files.forEach(function (inputFile) {
                if (inputFile.uuid === currentFile.uuid) {
                    var li = document.createElement('li');
                    var a = document.createElement('a');
                    a.textContent = file.name;
                    a.href = '#';
                    a.onclick = function () {
                        currentFile = file;
                        updatePage();
                        return false;
                    };
                    li.appendChild(a);
                    outputFilesList.appendChild(li);
                }
            });
        });
    }

    var maxDepth = 0;
    var colWidth = 200;

    function calculateDepths(file, depth = 0) {
        if (file.depth === undefined || file.depth < depth) {
            file.depth = depth;
        }
        maxDepth = Math.max(maxDepth, depth);

        file.input_files.forEach(function (inputFile) {
            var fileInData = data.files.find(function (f) {
                return f.uuid === inputFile.uuid;
            });
            calculateDepths(fileInData, depth + 1);
        });
    }


    calculateDepths(currentFile);
    // Multiple all depth per 2
    maxDepth *= 2;
    data.files.forEach(function (file) {
        file.depth *= 2;
    });

    var svg = document.getElementById('pipeline');
    svg.style.width = (maxDepth + 1) * colWidth + 'px';  // Adjust svg width based on maxDepth
    data.files.forEach(function (file) {
        var a = document.createElementNS('http://www.w3.org/2000/svg', 'a');
        a.href = '#';
        a.onclick = function () {
            currentFile = file;
            updatePage();
            return false;
        };

        var text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.textContent = file.name + ' (' + file.step.step + ')';
        var textX = (maxDepth - file.depth) * colWidth + colWidth / 2;

        text.setAttribute('x', textX);  // Adjust 'x' attribute based on maxDepth - file.depth
        text.setAttribute('text-anchor', 'middle');

        text.setAttribute('y', data.files.indexOf(file) * 20 + 20);  // Position nodes vertically based on order of appearance
        a.appendChild(text);

        svg.appendChild(a);

        file.input_files.forEach(function (inputFile) {
            var inputFileInData = data.files.find(function (f) {
                return f.uuid === inputFile.uuid;
            });
            var line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x2', (maxDepth - file.depth) * colWidth);
            line.setAttribute('y2', data.files.indexOf(file) * 20 + 20);
            line.setAttribute('x1', (maxDepth - (inputFileInData.depth - 1)) * colWidth);
            line.setAttribute('y1', data.files.indexOf(inputFileInData) * 20 + 20);
            line.style.stroke = 'rgba(0,0,0,0.3)';
            line.style.strokeWidth = '2px';
            // make it look like an arrow
            line.setAttribute('marker-end', 'url(#arrow)');


            svg.appendChild(line);
        });
    });
</script>


</body>
</html>
